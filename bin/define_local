#!/usr/bin/env perl
#
# setup products for the build environment
# use product_deps and MRB_QUALS

use File::Basename;
use lib dirname($0);


if( $#ARGV < 1 ) {
    $errfl1 = "problem_report";
    open(ERR1, "> $errfl1") or die "Couldn't open $errfl1";
    print ERR1 "\n";
    print ERR1 "unsetenv_ CETPKG_NAME\n";
    print ERR1 "unsetenv_ CETPKG_VERSION\n";
    print ERR1 "unsetenv_ CETPKG_QUAL\n";
    print ERR1 "unsetenv_ CETPKG_TYPE\n";
    print ERR1 "echo \"ERROR: directory not specified\"\n";
    print ERR1 "echo \"USAGE: define_local <input-directory> <build-directory> [extra qualifiers]>\"\n";
    print ERR1 "return 1\n";
    close(ERR1);
    print "$errfl1\n";
    exit 0;
}

$sourcedir = $ARGV[0];
$builddir = $ARGV[1];
$simple = "";
for $i ( 2 .. $#ARGV ) {
    if( $ARGV[$i] eq "simple" ) {
      $simple = "true";
    } else {
      $extra_qual = $extra_qual.$ARGV[$i].":";
    }
}

# use this file for debugging
$diagfl = $builddir."/diag_report";
open(DIAG, ">> $diagfl") or die "Couldn't open $diagfl";

$inputdir = $sourcedir."/ups";

require mrb_parse_deps;

$mrb_project = $ENV{MRB_PROJECT};
$mrb_version = $ENV{MRB_PROJECT_VERSION};
$mrb_quals = $ENV{MRB_QUALS};
$tmpfl = $builddir."/".$mrb_project."-".$mrb_version."-defs";
##print DIAG "opening $tmpfl for $mrb_project $mrb_version\n";
open(TSET, "+> $tmpfl") or die "Couldn't open $tmpfl";

##print DIAG "setup_products debug info: cmakefile  is $cmakefile\n";
print TSET "echo \$LD_LIBRARY_PATH\n";

# parse a list of dependencies
$dfile = $sourcedir."/dependency_list";
%deplist = get_dependency_list( $dfile, DIAG );

# have to find the list of packages to traverse
$cmakefile=$sourcedir."/CMakeLists.txt";
@package_list = get_package_list( $cmakefile, DIAG );
##print DIAG "DIAGNOSTICS: packages to check: @package_list\n";
if ( $#package_list < 0 ) {
  print DIAG "DIAGNOSTICS: there are no packages in $sourcedir\n";
  print DIAG "DIAGNOSTICS: nothing to build\n";
  print "$tmpfl\n";
  exit 0;
}
for $i ( 0 .. $#package_list ) {
  $pkg=$package_list[$i];
  $pfile=$sourcedir."/".$pkg."/ups/product_deps";
  ##print DIAG "checking $pfile for $pkg \n";
  ($productnames[$i], $productversn[$i]) = get_product_name( $pfile, DIAG );
  $productdefaultquals[$i] = find_default_qual( $pfile );
  ##print DIAG "DIAGNOSTICS: $productdefaultquals[$i] for $productnames[$i]\n";
}

# unsetup if necessary
print TSET "# unsetup products we are building\n";
##print DIAG "DIAGNOSTICS: packages to check: @package_list\n";
for $i ( 0 .. $#package_list ) {
  # call unsetup if the $productnames[$i] has been setup
  $psetup = "SETUP_".uc($productnames[$i]);
  $is_setup=$ENV{$psetup};
  ##print DIAG "DIAGNOSTICS: $psetup for $productnames[$i] is $is_setup\n";
  if ( $is_setup ) {
    print TSET "unsetup -j $productnames[$i]\n";
  }
}

# loop again and define package variables
print TSET "# set package variables\n";
print TSET "echo \$LD_LIBRARY_PATH\n";
for $i ( 0 .. $#package_list ) {
  $pkg=$package_list[$i];
  $pfile=$sourcedir."/".$pkg."/ups/product_deps";
  ##print DIAG "checking $pfile for $pkg \n";
  $product = $productnames[$i];
  $version = $productversn[$i];
  $qual    = $productdefaultquals[$i]; 

  $fcl_directory = get_fcl_directory( $pfile, $product );
  $gdml_directory = get_gdml_directory( $pfile, $product );
  # pretend this is a product
  $product_uc = uc($product);
  print TSET "setenv  ${product_uc}_VERSION $version\n";
  if ( $ENV{LD_LIBRARY_PATH} ne '' ) {
    # Below we want to remove the local products lib from the library path. The path is hard to find, since it is
    # product/version/lib and version is hard to predict. So we'll drop "$product/"  -- the final slash is important
    # as without it, dropit artg4 would also drop artg4examples and we don't want that.
    print TSET "setenv  LD_LIBRARY_PATH \`dropit -p \${LD_LIBRARY_PATH} \'${product}/\'\`\n";
  }
  if ( $ENV{DYLD_LIBRARY_PATH} ne '' ) {
    # Below we want to remove the local products lib from the library path. The path is hard to find, since it is
    # product/version/lib and version is hard to predict. So we'll drop "$product/"  -- the final slash is important
    # as without it, dropit artg4 would also drop artg4examples and we don't want that.
    print TSET "setenv  DYLD_LIBRARY_PATH \`dropit -p \${DYLD_LIBRARY_PATH} \'${product}/\'\`\n";
  }
  if ( $ENV{LD_LIBRARY_PATH} ne '' ) {
    print TSET "setenv  LD_LIBRARY_PATH $ENV{MRB_BUILDDIR}/${product}/lib:\${LD_LIBRARY_PATH}\n";
  }
  else {
    print TSET "setenv  LD_LIBRARY_PATH $ENV{MRB_BUILDDIR}/${product}/lib\n";
  }
  if ( $ENV{DYLD_LIBRARY_PATH} ne '' ) {
    print TSET "setenv  DYLD_LIBRARY_PATH $ENV{MRB_BUILDDIR}/${product}/lib:\${DYLD_LIBRARY_PATH}\n";
  }
  else {
    print TSET "setenv  DYLD_LIBRARY_PATH $ENV{MRB_BUILDDIR}/${product}/lib\n";
  }
  if ( "${fcl_directory}" ne "none" ) {
    ##print DIAG "$product: Run dropit for ---${fcl_directory}---\n";
    if ( $ENV{FHICL_FILE_PATH} ne '' ) {
      print TSET "setenv  FHICL_FILE_PATH \`dropit -p \${FHICL_FILE_PATH} \'${fcl_directory}\'\`\n";
      print TSET "setenv  FHICL_FILE_PATH $ENV{MRB_BUILDDIR}/${fcl_directory}:\${FHICL_FILE_PATH}\n";
    }
    else {
      print TSET "setenv  FHICL_FILE_PATH $ENV{MRB_BUILDDIR}/${fcl_directory}\n";
    }
  }
  if ( "${gdml_directory}" ne "none" ) {
    if ( $ENV{FW_SEARCH_PATH} ne '' ) {
      print TSET "setenv  FW_SEARCH_PATH \`dropit -p \${FW_SEARCH_PATH} \'${gdml_directory}\'\`\n";
      print TSET "setenv  FW_SEARCH_PATH $ENV{MRB_BUILDDIR}/${gdml_directory}:\${FW_SEARCH_PATH}\n";
    }
    else {
      print TSET "setenv  FW_SEARCH_PATH $ENV{MRB_BUILDDIR}/${gdml_directory}\n";
    }
  }

}
print TSET "echo \$LD_LIBRARY_PATH\n";

# cleanup
close(TSET);
close(DIAG);
print "$tmpfl\n";


exit 0;
