#----- Begin of mrbSetEnv ----
# NO USER-SERVICEABLE PARTS BELOW.
#
# There should be as little as possible here,
# with most of the heavy lifting done by other small scripts
#
# usage: source mrbSetEnv [optional extra qualifiers]


set_ msg1='ERROR: You MUST setup ups'
test -z $UPS_DIR && ( echo ""; echo "$msg1"; echo "" )
unset msg1
test -z $UPS_DIR && return

setenv CETPKG_SOURCE $MRB_SOURCE

# make sure we know the current directory
tnotnull MRB_BUILDDIR  && setenv CETPKG_BUILD $MRB_BUILDDIR
test -z "$CETPKG_BUILD" && setenv CETPKG_BUILD `pwd`

echo The working build directory is $CETPKG_BUILD
echo The source code directory is $CETPKG_SOURCE

set_ msg5='ERROR: setup of required products has failed'

echo ----------- check this block for errors -----------------------

ifcsh_
    # tcsh needs it this way
    source `${UPS_DIR}/bin/ups setup ${SETUP_UPS}`
else
    if [ "${ZSH_NAME}" ]
    then
        # zsh does word expansion differently
        . `${UPS_DIR}/bin/ups setup ${=SETUP_UPS}`
    else
        # bash likes it this way
        . `${UPS_DIR}/bin/ups setup ${SETUP_UPS}`
    fi
# Warning, this must be here because the tcsh parser is brain-dead.
endif
endifcsh_

setenv UPS_OPTIONS -B
# now get the rest of the products
#set_ cmd="$MRB_DIR/bin/setup_products $CETPKG_SOURCE $CETPKG_BUILD $*"
#echo Ready to run $cmd
set_ setup_fail="false"
source `$MRB_DIR/bin/setup_products $CETPKG_SOURCE $CETPKG_BUILD $*`
#echo "$cmd returned $setup_fail"
test "$setup_fail" = "true" && echo "$msg5"
test "$setup_fail" = "true" && unset msg5 && unset setup_fail && return 1
# finally, create fake products for local packages
#set_ cmd="$MRB_DIR/bin/define_local $CETPKG_SOURCE $CETPKG_BUILD $*"
#echo Ready to run $cmd
set_ setup_fail="false"
source `$MRB_DIR/bin/define_local $CETPKG_SOURCE $CETPKG_BUILD $*`
#echo "$cmd returned $setup_fail"
test "$setup_fail" = "true" && echo "$msg5"
unset msg5
test "$setup_fail" = "true" && unset setup_fail && return 1
unset setup_fail
test -e "$CETPKG_BUILD/diag_report" && cat $CETPKG_BUILD/diag_report

echo ----------------------------------------------------------------

#----- End of mrbSetEnv ----
